<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2c3e50">
  <title data-translate="dynamics.title">Dinamik Simülasyon</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <script src="translations.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
  <div class="language-selector">
    <select id="languageSelect" onchange="changeLanguage(this.value)">
      <option value="tr">Türkçe</option>
      <option value="en">English</option>
    </select>
  </div>

  <nav>
    <a href="index.html" data-translate="nav.home">Ana Sayfa</a>
    <a href="reactor.html" data-translate="nav.reactor">Reaktör Tasarım</a>
    <a href="chemical.html" data-translate="nav.chemical">Kimyasal Denge</a>
    <a href="heattransfer.html" data-translate="nav.heat">Isı Transferi</a>
    <a href="dynamics.html" data-translate="nav.dynamics">Dinamik Simülasyon</a>
    <a href="optimization.html" data-translate="nav.optimization">Reaktör Optimizasyonu</a>
    <a href="history.html" data-translate="nav.history">Hesaplama Geçmişi</a>
  </nav>

  <div class="page-header">
    <h1 data-translate="dynamics.pageTitle">Dinamik Simülasyon</h1>
    <p data-translate="dynamics.pageDesc">Reaktör sistemlerinin zamana bağlı davranışı</p>
  </div>

  <div class="grid-container">
    <div class="controls">
      <div class="input-group">
        <label for="reactor_type" data-translate="dynamics.reactorType">Reaktör Tipi</label>
        <select id="reactor_type">
          <option value="CSTR" data-translate="dynamics.cstr">CSTR</option>
          <option value="PFR" data-translate="dynamics.pfr">PFR</option>
        </select>
      </div>

      <div class="input-group">
        <label for="k_forward" data-translate="dynamics.k1">İleri Reaksiyon Sabiti (k₁)</label>
        <input type="number" id="k_forward" step="any">
      </div>

      <div class="input-group">
        <label for="initial_conc" data-translate="dynamics.initialConc">Başlangıç Konsantrasyonu</label>
        <input type="number" id="initial_conc" step="any">
      </div>

      <div class="input-group">
        <label for="flow_rate" data-translate="dynamics.flowRate">Akış Hızı (L/s)</label>
        <input type="number" id="flow_rate" step="any">
      </div>

      <div class="simulation-controls">
        <button id="startBtn" data-translate="common.start">Başlat</button>
        <button id="pauseBtn" data-translate="common.pause">Duraklat</button>
        <button id="resetBtn" data-translate="common.reset">Sıfırla</button>
      </div>
    </div>

    <div class="visualization-container">
      <div class="tab-navigation">
        <button class="tab-btn active" data-view="concentration" data-translate="dynamics.concTab">
          Konsantrasyon
        </button>
        <button class="tab-btn" data-view="conversion" data-translate="dynamics.convTab">
          Dönüşüm
        </button>
        <button class="tab-btn" data-view="3d" data-translate="dynamics.view3d">
          3D Görünüm
        </button>
      </div>
      <div id="concentrationPlot"></div>
      <div id="conversionPlot" style="display: none;"></div>
      <div id="reactor3d" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Touch olayları ve dil desteği
    document.addEventListener('DOMContentLoaded', function() {
      // Çift dokunma zoom'unu engelle
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      // Pinch zoom'u engelle
      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      // Tercih edilen dili yükle
      const preferredLanguage = localStorage.getItem('preferredLanguage') || 'tr';
      document.getElementById('languageSelect').value = preferredLanguage;
      translatePage(preferredLanguage);
    });

    let simulation = null;
    let animationId = null;
    let timeData = [];
    let concentrationData = [];
    let conversionData = [];
    let currentTime = 0;

    class ReactorSimulation {
      constructor(type, F_in, C_in, k, V) {
        this.type = type;
        this.F_in = F_in;
        this.C_in = C_in;
        this.k = k;
        this.V = V;
        this.C = 0;
        this.dt = 0.1;
      }

      step() {
        if (this.type === 'CSTR') {
          // dC/dt = F_in/V * (C_in - C) - k*C
          const dC = (this.F_in/this.V) * (this.C_in - this.C) - this.k * this.C;
          this.C += dC * this.dt;
        } else {
          // PFR için sürekli hal çözümü
          this.C = this.C_in * Math.exp(-this.k * this.V / this.F_in);
        }
        return this.C;
      }

      getConversion() {
        return (this.C_in - this.C) / this.C_in;
      }
    }

    function initSimulation() {
      const type = document.getElementById('reactor_type').value;
      const F_in = parseFloat(document.getElementById('flow_rate').value);
      const C_in = parseFloat(document.getElementById('initial_conc').value);
      const k = parseFloat(document.getElementById('k_forward').value);
      const V = parseFloat(document.getElementById('V').value);

      simulation = new ReactorSimulation(type, F_in, C_in, k, V);
      timeData = [0];
      concentrationData = [simulation.C];
      conversionData = [0];
      currentTime = 0;

      updatePlots();
      init3DVisualization();
    }

    function updatePlots() {
      // Konsantrasyon grafiği
      Plotly.newPlot('concentrationPlot', [{
        x: timeData,
        y: concentrationData,
        type: 'scatter',
        mode: 'lines',
        name: 'Konsantrasyon',
        line: { color: '#e74c3c' }
      }], {
        title: 'Konsantrasyon vs. Zaman',
        xaxis: { title: 'Zaman (s)' },
        yaxis: { title: 'Konsantrasyon (mol/L)' },
        height: 400
      });

      // Dönüşüm grafiği
      Plotly.newPlot('conversionPlot', [{
        x: timeData,
        y: conversionData,
        type: 'scatter',
        mode: 'lines',
        name: 'Dönüşüm',
        line: { color: '#2ecc71' }
      }], {
        title: 'Dönüşüm vs. Zaman',
        xaxis: { title: 'Zaman (s)' },
        yaxis: { title: 'Dönüşüm' },
        height: 400
      });
    }

    function animate() {
      if (simulation && currentTime < parseFloat(document.getElementById('sim_time').value)) {
        currentTime += simulation.dt;
        const C = simulation.step();
        const X = simulation.getConversion();

        timeData.push(currentTime);
        concentrationData.push(C);
        conversionData.push(X);

        Plotly.update('concentrationPlot', {
          x: [timeData],
          y: [concentrationData]
        });

        Plotly.update('conversionPlot', {
          x: [timeData],
          y: [conversionData]
        });

        update3DVisualization(C/simulation.C_in);
        animationId = requestAnimationFrame(animate);
      } else {
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
      }
    }

    // Event listeners
    document.getElementById('startBtn').addEventListener('click', function() {
      if (!simulation) {
        initSimulation();
      }
      this.disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('resetBtn').disabled = false;
      animate();
    });

    document.getElementById('pauseBtn').addEventListener('click', function() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
        this.disabled = true;
        document.getElementById('startBtn').disabled = false;
      }
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      simulation = null;
      timeData = [];
      concentrationData = [];
      conversionData = [];
      currentTime = 0;
      updatePlots();
      init3DVisualization();
      document.getElementById('startBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = true;
      this.disabled = true;
    });

    // Tab değiştirme
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const view = this.dataset.view;
        document.getElementById('concentrationPlot').style.display = 
          view === 'concentration' ? 'block' : 'none';
        document.getElementById('conversionPlot').style.display = 
          view === 'conversion' ? 'block' : 'none';
        document.getElementById('reactor3d').style.display = 
          view === '3d' ? 'block' : 'none';
      });
    });
  </script>
</body>
</html>
