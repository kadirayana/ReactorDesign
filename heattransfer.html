<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2c3e50">
  <title data-translate="heat.title">Isı Transferi</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <script src="translations.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
  <div class="language-selector">
    <select id="languageSelect" onchange="changeLanguage(this.value)">
      <option value="tr">Türkçe</option>
      <option value="en">English</option>
    </select>
  </div>

  <nav>
    <a href="index.html">Ana Sayfa</a>
    <a href="reactor.html">Reaktör Tasarım</a>
    <a href="chemical.html">Kimyasal Denge</a>
    <a href="heattransfer.html">Isı Transferi</a>
    <a href="dynamics.html">Dinamik Simülasyon</a>
    <a href="optimization.html">Reaktör Optimizasyonu</a>
    <a href="history.html">Hesaplama Geçmişi</a>
  </nav>

  <div class="page-header">
    <h1 data-translate="heat.pageTitle">Isı Transferi Hesaplamaları</h1>
    <p data-translate="heat.pageDesc">Reaktör sistemlerinde ısı transferi analizi</p>
  </div>

  <div class="grid-container">
    <div class="controls">
      <div class="input-group">
        <label for="reactor_type" data-translate="heat.reactorType">Reaktör Tipi</label>
        <select id="reactor_type">
          <option value="PFR" data-translate="heat.pfr">Piston Akışlı Reaktör</option>
          <option value="CSTR" data-translate="heat.cstr">Karıştırmalı Tank Reaktörü</option>
        </select>
      </div>

      <div class="input-group">
        <label for="T_in" data-translate="heat.inletTemp">Giriş Sıcaklığı (°C)</label>
        <input type="number" id="T_in" step="any">
      </div>

      <div class="input-group">
        <label for="T_cool" data-translate="heat.coolantTemp">Soğutucu Sıcaklığı (°C)</label>
        <input type="number" id="T_cool" step="any">
      </div>

      <div class="input-group">
        <label for="dH" data-translate="heat.reactionHeat">Reaksiyon Isısı (kJ/mol)</label>
        <input type="number" id="dH" step="any">
      </div>

      <div class="input-group">
        <label for="U" data-translate="heat.heatTransfer">Isı Transfer Katsayısı (W/m²K)</label>
        <input type="number" id="U" step="any">
      </div>

      <button id="calculateBtn" data-translate="common.calculate">Hesapla</button>
    </div>

    <div class="visualization-container">
      <div class="tab-navigation">
        <button class="tab-btn active" data-view="temperature" data-translate="heat.tempProfile">
          Sıcaklık Profili
        </button>
        <button class="tab-btn" data-view="3d" data-translate="heat.view3d">
          3D Görünüm
        </button>
      </div>
      <div id="temperaturePlot"></div>
      <div id="reactor3d" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Touch olayları ve dil desteği
    document.addEventListener('DOMContentLoaded', function() {
      // ... (mevcut touch ve dil desteği kodu) ...
    });

    // Plotly konfigürasyonu
    const plotlyConfig = {
      responsive: true,
      displayModeBar: false,
      displaylogo: false
    };

    // Sıcaklık profili hesaplama ve görselleştirme
    function calculateTemperatureProfile(type, T_in, T_cool, dH, U, length) {
      const points = 100;
      const z = Array.from({length: points}, (_, i) => (i * length) / (points - 1));
      let T;
      
      if (type === 'PFR') {
        // PFR için sıcaklık profili
        T = z.map(z_i => {
          return T_cool + (T_in - T_cool) * Math.exp(-U * z_i);
        });
      } else {
        // CSTR için sabit sıcaklık
        T = z.map(() => T_in);
      }

      return {z, T};
    }

    // 3D görselleştirme
    function init3DVisualization(type, T_in, T_cool, dH, U) {
      const container = document.getElementById('reactor3d');
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);

      const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.innerHTML = '';
      container.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Reaktör geometrisi
      const geometry = type === 'PFR' ? 
        new THREE.CylinderGeometry(0.5, 0.5, 5, 32) :
        new THREE.CylinderGeometry(1, 1, 2, 32);

      // Sıcaklık gradyanı için malzeme
      const segments = 20;
      const materials = [];
      
      for (let i = 0; i < segments; i++) {
        const t = i / (segments - 1);
        const temperature = T_cool + (T_in - T_cool) * (1 - t);
        const color = getTemperatureColor(temperature, T_cool, T_in);
        
        materials.push(new THREE.MeshPhongMaterial({
          color: color,
          transparent: true,
          opacity: 0.8
        }));
      }

      // Reaktör oluşturma
      const reactor = type === 'PFR' ?
        createPFRWithTemperature(geometry, materials) :
        createCSTRWithTemperature(geometry, materials);

      scene.add(reactor);

      // Işıklandırma
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);

      const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
      light1.position.set(1, 1, 1);
      scene.add(light1);

      const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
      light2.position.set(-1, -1, -1);
      scene.add(light2);

      camera.position.set(5, 5, 5);
      controls.update();

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }

      animate();
    }

    // Sıcaklığa göre renk hesaplama
    function getTemperatureColor(temp, minTemp, maxTemp) {
      const t = (temp - minTemp) / (maxTemp - minTemp);
      const hue = (1 - t) * 240; // 240 (mavi) -> 0 (kırmızı)
      return new THREE.Color(`hsl(${hue}, 100%, 50%)`);
    }

    // PFR reaktör oluşturma
    function createPFRWithTemperature(geometry, materials) {
      const group = new THREE.Group();
      const segmentHeight = geometry.parameters.height / materials.length;

      materials.forEach((material, i) => {
        const segmentGeometry = new THREE.CylinderGeometry(
          geometry.parameters.radiusTop,
          geometry.parameters.radiusBottom,
          segmentHeight,
          geometry.parameters.radialSegments
        );

        const segment = new THREE.Mesh(segmentGeometry, material);
        segment.position.y = (i - materials.length/2) * segmentHeight;
        group.add(segment);
      });

      // Soğutma ceketi
      const jacketGeometry = new THREE.CylinderGeometry(
        geometry.parameters.radiusTop * 1.2,
        geometry.parameters.radiusBottom * 1.2,
        geometry.parameters.height,
        geometry.parameters.radialSegments
      );
      
      const jacketMaterial = new THREE.MeshPhongMaterial({
        color: 0x88ccff,
        transparent: true,
        opacity: 0.3
      });
      
      const jacket = new THREE.Mesh(jacketGeometry, jacketMaterial);
      group.add(jacket);

      return group;
    }

    // CSTR reaktör oluşturma
    function createCSTRWithTemperature(geometry, materials) {
      const group = new THREE.Group();
      
      // Ana tank
      const tank = new THREE.Mesh(geometry, materials[0]); // CSTR için tek sıcaklık
      group.add(tank);

      // Karıştırıcı
      const shaftGeometry = new THREE.CylinderGeometry(0.05, 0.05, 2.5, 16);
      const shaftMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
      const shaft = new THREE.Mesh(shaftGeometry, shaftMaterial);
      group.add(shaft);

      // Soğutma ceketi
      const jacketGeometry = new THREE.CylinderGeometry(1.2, 1.2, 2, 32);
      const jacketMaterial = new THREE.MeshPhongMaterial({
        color: 0x88ccff,
        transparent: true,
        opacity: 0.3
      });
      const jacket = new THREE.Mesh(jacketGeometry, jacketMaterial);
      group.add(jacket);

      return group;
    }

    // Event listeners
    document.getElementById('calculateBtn').addEventListener('click', function() {
      const type = document.getElementById('reactor_type').value;
      const T_in = parseFloat(document.getElementById('T_in').value);
      const T_cool = parseFloat(document.getElementById('T_cool').value);
      const dH = parseFloat(document.getElementById('dH').value);
      const U = parseFloat(document.getElementById('U').value);

      if (isNaN(T_in) || isNaN(T_cool) || isNaN(dH) || isNaN(U)) {
        alert('Lütfen tüm alanları doldurun');
        return;
      }

      // Sıcaklık profili hesaplama ve çizme
      const length = type === 'PFR' ? 5 : 2;
      const profile = calculateTemperatureProfile(type, T_in, T_cool, dH, U, length);

      Plotly.newPlot('temperaturePlot', [{
        x: profile.z,
        y: profile.T,
        type: 'scatter',
        mode: 'lines',
        line: {
          color: '#e74c3c',
          width: 3
        },
        name: 'Sıcaklık Profili'
      }], {
        title: 'Reaktör Boyunca Sıcaklık Profili',
        xaxis: {
          title: 'Reaktör Uzunluğu (m)'
        },
        yaxis: {
          title: 'Sıcaklık (°C)'
        },
        height: 400
      });

      // 3D görselleştirme
      init3DVisualization(type, T_in, T_cool, dH, U);
    });

    // Tab değiştirme
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const view = this.dataset.view;
        document.getElementById('temperaturePlot').style.display = 
          view === 'temperature' ? 'block' : 'none';
        document.getElementById('reactor3d').style.display = 
          view === '3d' ? 'block' : 'none';
      });
    });
  </script>
</body>
</html>
